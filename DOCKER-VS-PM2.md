# Docker vs PM2: что выбрать для ipg-invest.ae

## Краткий ответ

| Ситуация | Рекомендация |
|----------|--------------|
| **Один сервер, хотите минимум возни** | **Docker** |
| **Уже есть PostgreSQL/Redis на сервере** | **PM2** |
| **Нужна максимальная предсказуемость и переносимость** | **Docker** |
| **Мало RAM (< 2 GB)** | **PM2** (Docker тяжелее) |
| **Планируете масштабирование / несколько серверов** | **Docker** |

---

## Сравнение

### Docker

**Плюсы:**
- Одна команда поднимает всё: PostgreSQL, Redis, API, 4 фронта, Nginx.
- Одинаковое окружение на любой машине (Windows, Ubuntu, VPS).
- БД и Redis не нужно ставить вручную — всё в контейнерах.
- Обновление: `docker compose pull && docker compose up -d`.
- Откат: переключиться на предыдущий образ.
- Удобно бэкапить данные через volumes.
- Изоляция: конфликтов портов/версий с другими приложениями меньше.

**Минусы:**
- Нужно установить Docker и Docker Compose.
- Больше потребление RAM (примерно +500 MB–1 GB на контейнеры).
- Первый раз нужно разобраться с `docker-compose` и `.env`.

**Когда логично:** один VPS/сервер, хочется быстро и стабильно поднять весь стек (БД + Redis + API + фронты).

---

### PM2

**Плюсы:**
- Запускает только Node.js (API + Telegram-бот).
- Меньше потребление RAM, чем у полного Docker-стека.
- Удобные логи и перезапуск: `pm2 logs`, `pm2 restart`.
- PostgreSQL и Redis вы ставите сами — можно использовать уже существующие или общую БД.

**Минусы:**
- PostgreSQL и Redis нужно установить и настроить отдельно (порты, пользователи, данные).
- Фронты нужно собрать (`npm run build`) и отдавать через Nginx (статика).
- Больше ручных шагов при первом деплое и при добавлении новых приложений.
- Разные версии Node/БД на разных серверах могут вести себя по-разному.

**Когда логично:** БД и Redis уже есть на сервере, или сервер слабый (мало RAM), или вы привыкли к PM2.

---

## Рекомендация для вашего проекта

### Предпочтительный вариант: **Docker**

Причины:

1. **Всё в одном месте**  
   PostgreSQL, Redis, API, 4 фронта и Nginx описываются в `docker-compose.yml`. Запуск одной командой, меньше шансов что-то забыть.

2. **База данных**  
   У вас уже есть скрипты миграции и важные требования к кодировке/схеме. В Docker БД поднимается с нужными параметрами (`encoding=UTF8`, `schema.sql`), не нужно править системный PostgreSQL на хосте.

3. **Одинаковое окружение**  
   На любом сервере с Docker результат будет тем же: те же версии Node, PostgreSQL, Redis, Nginx.

4. **Обновления и откаты**  
   Обновили код → пересобрали образы → `docker compose up -d`. Проблемы — откатились на предыдущий образ.

5. **Документация**  
   У вас уже есть `docker-compose.yml`, Dockerfile’ы и гайд по деплою под Docker — проще идти по готовому пути.

Имеет смысл выбрать **PM2**, если:
- на сервере уже крутятся PostgreSQL и Redis и вы хотите их использовать;
- у VPS мало RAM (например, 1 GB) и каждый мегабайт важен;
- вы принципиально не хотите использовать Docker.

---

## Что делать по шагам

### Вариант A: Docker (рекомендуется)

```bash
# На Ubuntu
cd /var/www/ipg
cp .env.production.example .env
nano .env   # подставить пароли и секреты

docker compose build
docker compose up -d

# Проверка
docker compose ps
curl http://localhost:3001/health
```

Детали — в `DEPLOY-UBUNTU-GUIDE.md`, раздел «Деплой с Docker».

### Вариант B: PM2

```bash
# 1. Установить и настроить PostgreSQL и Redis вручную
sudo bash server/scripts/setup-ubuntu-database.sh
# Импорт БД: server/scripts/import-database.sh

# 2. Собрать фронты и отдать через Nginx
cd Dashboard && npm run build
# Аналогично для Invest-Lending, Info, Wallet
# Скопировать dist в /var/www/html/... и настроить Nginx

# 3. Запустить API через PM2
cd /var/www/ipg
pm2 start ecosystem.config.js --env production
pm2 save && pm2 startup
```

Детали — в `DEPLOY-UBUNTU-GUIDE.md`, раздел «Деплой без Docker (PM2)».

---

## Итог

| Критерий | Docker | PM2 |
|----------|--------|-----|
| Простота первого деплоя | Выше | Ниже |
| Управление БД/Redis | В контейнерах | Вручную на хосте |
| Потребление RAM | Выше | Ниже |
| Обновления | Проще | Больше ручных шагов |
| Переносимость | Выше | Зависит от сервера |

Для **ipg-invest.ae** на одном сервере рациональнее начать с **Docker**. Если позже появятся ограничения по ресурсам или уже существующая БД — можно перейти на PM2 для API и оставить БД/Redis как есть.
